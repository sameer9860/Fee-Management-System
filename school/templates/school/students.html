{% extends 'base.html' %}
{% load form_extras %}

{% block title %}
Students
{% endblock title %}

{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<main class="min-h-screen flex flex-col p-6 w-full">

    <!-- Page Title -->
    <h1 class="text-2xl font-bold mb-3">Student Management</h1>

    <div class="flex  gap-8">

        <!-- Left Section -->
        <div class=" flex flex-col flex-grow max-w-[500px] max-h-[90vh] overflow-y-auto">

            <!-- Student Registration Form -->
            <div class=" shadow rounded-2xl p-6 ">
                <h2 class="text-xl font-semibold mb-4">Register a Student</h2>
                <form method="post" enctype="multipart/form-data" class="">
                    {% csrf_token %}

                    {% for field in form %}
                    <fieldset class="fieldset mb-2">
                        <legend class="fieldset-legend text-sm font-medium ">
                            {{ field.label }}
                        </legend>
                        {{ field|add_class:"input input-bordered w-full" }}
                        {% if field.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ field.errors|striptags }}</p>
                        {% endif %}
                    </fieldset>
                    {% endfor %}

                    <button type="submit" class="w-full btn btn-primary">
                        Register Student
                    </button>
                </form>

            </div>

            <!-- CSV Upload Form -->
            <div class=" shadow rounded-2xl p-6">
                <h2 class="text-xl font-semibold mb-4">Bulk Upload Students (CSV)</h2>
                <form method="post" enctype="multipart/form-data" action="{% url 'school:upload_students_csv' %}">
                    {% csrf_token %}
                    <fieldset class="fieldset mb-2">

                        {{ csv_form.grade|add_class:"select input input-bordered w-full" }}
                        {% if csv_form.grade.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ csv_form.grade.errors|striptags }}</p>
                        {% endif %}
                    </fieldset>
                    <fieldset class="fieldset mb-2">

                        {{ csv_form.csv_file|add_class:"file-input input-bordered w-full" }}
                        {% if csv_form.csv_file.errors %}
                        <p class="text-red-500 text-sm mt-1">{{ csv_form.csv_file.errors|striptags }}</p>
                        {% endif %}
                    </fieldset>

                    <button type="submit" class="w-full btn btn-primary">
                        Upload CSV
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Section (Student List) -->
        <div class=" flex-grow  shadow rounded-2xl p-6">
            <form action="" method="get" class="flex gap-2 items-baseline">
                {% for field in filter_form %}
                <fieldset class="fieldset mb-2">
                    <legend class="fieldset-legend text-sm font-medium ">
                        {{ field.label }}
                    </legend>
                    {{ field|add_class:"input input-bordered input-sm" }}
                    {% if field.errors %}
                    <p class="text-red-500 text-sm mt-1">{{ field.errors|striptags }}</p>
                    {% endif %}
                </fieldset>
                {% endfor %}

                <button type="submit" class=" btn btn-sm btn-primary">
                    Filter
                </button>
                <button class="btn btn-sm btn-error" type="reset">Reset</button>
            </form>

            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Students List</h2>
                <div class="text-sm text-gray-500">Total: <strong>{{ total_students }}</strong></div>
            </div>
            <div class="overflow-x-auto rounded-box border border-base-content/5 bg-base-100">
                <table class="table w-full">
                    <!-- head -->
                    <thead>
                        <tr>
                            <th>SN</th>
                            <th>Student</th>
                            <th>Grade</th>
                            <th>Contact</th>
                            <th>Address</th>
                            <th>Actions</th>

                        </tr>
                    </thead>
                    <tbody id="student-list">

                        {% if page_obj.object_list %}
                        {% for student in page_obj %}
                        <!-- row -->
                        <tr>
                            <th>{{ forloop.counter }}</th>
                            <td class="flex items-center gap-3">
                                {% if student.profile_pic %}
                                <img src="{{ student.profile_pic.url }}" alt="avatar" class="w-10 h-10 rounded-full object-cover">
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center">{{ student.first_name|default:student.username|slice:":1"|upper }}</div>
                                {% endif %}
                                <div>
                                    <div class="font-medium">{{ student.get_full_name }}</div>
                                    <div class="text-xs text-gray-500">{{ student.email }}</div>
                                </div>
                            </td>
                            <td><span class="badge badge-outline">{{ student.grade.name }}</span></td>
                            <td>
                                <div class="text-sm">{{ student.phone_number|default:'-' }}</div>
                            </td>
                            <td>{{ student.address|default:'-' }}</td>
                            <td>
                                <div class="flex gap-3">
                                    <!-- Profile -->
                                    <a href="{% url 'school:student_profile' student.id %}" class="text-blue-500 hover:text-blue-700" title="Profile">
                                        <i class="bi bi-person-circle text-xl"></i>
                                    </a>
                                    
                                    <!-- Edit -->
                                    <a href="{% url 'school:student_update' student.id %}" class="text-yellow-500 hover:text-yellow-700" title="Edit">
                                        <i class="bi bi-pencil-square text-xl"></i>
                                    </a>
                                    
                                    <!-- Delete -->
                                    <a href="{% url 'school:student_delete' student.id %}" class="text-red-500 hover:text-red-700" title="Delete">
                                        <i class="bi bi-trash-fill text-xl"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-10">No students found. Register students using the form or upload CSV.</td>
                        </tr>
                        {% endif %}



                    </tbody>

                </table>
                <div class="join flex justify-end">
                    {% if page_obj.has_previous %}
                    <a href="?page=1" class="join-item btn">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="join-item btn">«</a>
                    {% endif %}
                    <a class="join-item btn">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</a>
                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="join-item btn">»</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="join-item btn">Last</a>
                    {% endif %}

                </div>
            </div>
        </div>

    </div>
</main>
{% endblock %}